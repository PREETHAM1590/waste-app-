<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced Token Tester | Waste Wise</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2a;
      --text: #e8f0ff;
      --muted: #a5b4d4;
      --primary: #2dd4bf;
      --accent: #22c55e;
      --warn: #f59e0b;
      --error: #ef4444;
      --border: #263249;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    .container { max-width: 1200px; margin: 40px auto; padding: 0 16px; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.25); margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    h1 { font-size: 24px; margin: 0 0 20px; }
    h2 { font-size: 18px; margin: 0 0 16px; color: var(--primary); }
    h3 { font-size: 16px; margin: 16px 0 10px; color: var(--muted); }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, select, button, textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0e1626; color: var(--text); margin-bottom: 12px; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); }
    .btn { cursor: pointer; background: var(--primary); border: none; color: #001010; font-weight: 700; letter-spacing: .2px; }
    .btn.secondary { background: var(--accent); }
    .btn.warn { background: var(--warn); color: #1f1500; }
    .btn.small { padding: 6px 12px; font-size: 12px; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap; background: #0a1020; padding: 12px; border-radius: 10px; border: 1px solid var(--border); height: 300px; overflow: auto; }
    .tag { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #0c1b2f; border: 1px solid var(--border); font-size: 12px; }
    .status { padding: 8px 12px; border-radius: 8px; font-size: 13px; margin-bottom: 12px; }
    .status.success { background: rgba(34, 197, 94, 0.1); border: 1px solid var(--accent); color: var(--accent); }
    .status.error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); color: var(--error); }
    .status.warn { background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warn); color: var(--warn); }
    .row { display: flex; gap: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>ğŸ¯ Advanced Token Distribution Tester</h1>
      <div id="apiStatus" class="status warn">Checking API connection...</div>
      <div class="grid-2">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" value="http://localhost:3001" />
        </div>
        <div>
          <label>Test User Wallet Address</label>
          <input id="wallet" placeholder="Enter Solana wallet address" />
        </div>
      </div>
      <div class="row">
        <button class="btn small" id="btnCheckApi">ğŸ” Test API Connection</button>
        <button class="btn small secondary" id="btnGetTokenInfo">ğŸ“Š Token Info</button>
        <button class="btn small warn" id="btnAirdropSol">ğŸ’° Airdrop 2 SOL</button>
      </div>
    </div>

    <div class="grid">
      <!-- Scan Rewards -->
      <div class="panel">
        <h2>â™»ï¸ Scan Rewards</h2>
        <label>User ID</label>
        <input id="scanUserId" value="demo-user" />
        
        <label>Item Type</label>
        <select id="scanItemType">
          <option value="plastic_bottle">ğŸ¼ Plastic Bottle</option>
          <option value="paper">ğŸ“„ Paper</option>
          <option value="glass">ğŸº Glass</option>
          <option value="metal_can">ğŸ¥« Metal Can</option>
          <option value="cardboard">ğŸ“¦ Cardboard</option>
          <option value="electronic">ğŸ“± Electronic</option>
        </select>
        
        <div class="grid-2">
          <div>
            <label>Confidence (0-1)</label>
            <input id="scanConfidence" type="number" step="0.05" min="0" max="1" value="0.95" />
          </div>
          <div>
            <label>Is Correct?</label>
            <select id="scanCorrect">
              <option value="true">âœ… Correct</option>
              <option value="false">âŒ Incorrect</option>
            </select>
          </div>
        </div>
        
        <button class="btn" id="btnScanReward">Send Scan Reward</button>
        <div id="scanResult" class="muted"></div>
      </div>

      <!-- Streak Rewards -->
      <div class="panel">
        <h2>ğŸ”¥ Streak Rewards</h2>
        <label>User ID</label>
        <input id="streakUserId" value="demo-user" />
        
        <div class="grid-2">
          <div>
            <label>Current Streak (days)</label>
            <input id="streakDays" type="number" min="1" max="365" value="7" />
          </div>
          <div>
            <label>Streak Type</label>
            <select id="streakType">
              <option value="daily">ğŸ“… Daily</option>
              <option value="weekly">ğŸ“Š Weekly</option>
              <option value="monthly">ğŸ“ˆ Monthly</option>
            </select>
          </div>
        </div>
        
        <label>New Record?</label>
        <select id="streakRecord">
          <option value="true">ğŸ‰ Yes, New Record!</option>
          <option value="false">ğŸ“ˆ Normal Streak</option>
        </select>
        
        <button class="btn secondary" id="btnStreakReward">Award Streak Bonus</button>
        <div id="streakResult" class="muted"></div>
      </div>

      <!-- Achievement Rewards -->
      <div class="panel">
        <h2>ğŸ† Achievement Rewards</h2>
        <label>User ID</label>
        <input id="achUserId" value="demo-user" />
        
        <label>Achievement Type</label>
        <select id="achType">
          <option value="recycling">â™»ï¸ Recycling Milestone</option>
          <option value="accuracy">ğŸ¯ Accuracy Milestone</option>
          <option value="streak">ğŸ”¥ Streak Milestone</option>
          <option value="community">ğŸ¤ Community Contribution</option>
        </select>
        
        <div class="grid-2">
          <div>
            <label>Milestone Value</label>
            <input id="achMilestone" type="number" min="1" value="100" />
          </div>
          <div>
            <label>Is Rare Achievement?</label>
            <select id="achRare">
              <option value="false">ğŸ… Normal</option>
              <option value="true">ğŸ’ Rare (2x bonus!)</option>
            </select>
          </div>
        </div>
        
        <button class="btn warn" id="btnAchievement">Unlock Achievement</button>
        <div id="achResult" class="muted"></div>
      </div>
    </div>

    <!-- Community & Advanced -->
    <div class="grid-2">
      <div class="panel">
        <h2>ğŸ¤ Community Rewards</h2>
        <label>User ID</label>
        <input id="commUserId" value="demo-user" />
        
        <label>Activity Type</label>
        <select id="commActivity">
          <option value="tip_sharing">ğŸ’¡ Tip Sharing</option>
          <option value="location_reporting">ğŸ“ Location Reporting</option>
          <option value="community_challenge">ğŸ† Community Challenge</option>
          <option value="mentoring">ğŸ‘¨â€ğŸ« Mentoring</option>
          <option value="content_creation">ğŸ“ Content Creation</option>
        </select>
        
        <div class="grid-2">
          <div>
            <label>Impact Level</label>
            <select id="commImpact">
              <option value="low">ğŸ“ˆ Low</option>
              <option value="medium">ğŸ“Š Medium</option>
              <option value="high">ğŸš€ High</option>
              <option value="viral">ğŸ’¥ Viral</option>
            </select>
          </div>
          <div>
            <label>User Level</label>
            <select id="commLevel">
              <option value="beginner">ğŸŒ± Beginner</option>
              <option value="intermediate">ğŸŒ¿ Intermediate</option>
              <option value="advanced">ğŸŒ³ Advanced</option>
              <option value="expert">ğŸ… Expert</option>
              <option value="master">ğŸ‘‘ Master</option>
            </select>
          </div>
        </div>
        
        <button class="btn secondary" id="btnCommunity">Award Community Points</button>
        <div id="commResult" class="muted"></div>
      </div>

      <div class="panel">
        <h2>ğŸ”§ Utilities</h2>
        
        <h3>Balance Check</h3>
        <button class="btn small" id="btnCheckBalance">ğŸ’° Check Token Balance</button>
        
        <h3>Queue Management</h3>
        <button class="btn small secondary" id="btnProcessQueue">âš¡ Process Queue Now</button>
        <button class="btn small" id="btnQueueStatus">ğŸ“Š Queue Status</button>
        
        <h3>System Stats</h3>
        <button class="btn small warn" id="btnSystemStats">ğŸ“ˆ Get System Stats</button>
        
        <h3>Transaction Tracking</h3>
        <input id="txHash" placeholder="Enter transaction signature" />
        <button class="btn small" id="btnTrackTx">ğŸ” Track Transaction</button>
        
        <div id="utilsResult" class="muted" style="font-size: 11px;"></div>
      </div>
    </div>

    <!-- Logs -->
    <div class="panel">
      <h2>ğŸ“ Activity Logs</h2>
      <div class="row" style="margin-bottom: 12px;">
        <button class="btn small" id="btnClearLogs">ğŸ—‘ï¸ Clear Logs</button>
        <button class="btn small secondary" id="btnExportLogs">ğŸ’¾ Export Logs</button>
      </div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    let logCount = 0;
    
    const log = (msg, obj) => {
      logCount++;
      const ts = new Date().toLocaleTimeString();
      const line = typeof obj !== 'undefined' 
        ? `[${logCount}] ${ts} â€” ${msg}\n${JSON.stringify(obj, null, 2)}\n` 
        : `[${logCount}] ${ts} â€” ${msg}\n`;
      $('log').textContent = line + "\n" + $('log').textContent;
    };

    const get = async (path) => {
      const res = await fetch($('apiBase').value + path);
      return res.json();
    };
    
    const post = async (path, body) => {
      const res = await fetch($('apiBase').value + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return res.json();
    };

    const updateApiStatus = (success, message) => {
      const status = $('apiStatus');
      status.className = success ? 'status success' : 'status error';
      status.textContent = success ? 'âœ… API Connected: ' + message : 'âŒ API Error: ' + message;
    };

    // API Connection Test
    $('btnCheckApi').onclick = async () => {
      try {
        const data = await get('/health');
        updateApiStatus(true, data.message);
        log('âœ… API Health Check', data);
      } catch (e) {
        updateApiStatus(false, e.message);
        log('âŒ API Health Check Failed', e);
      }
    };

    // Token Info
    $('btnGetTokenInfo').onclick = async () => {
      try {
        const data = await get('/api/rewards/token-info');
        log('ğŸª™ Token Information', data);
      } catch (e) {
        log('âŒ Token Info Failed', e);
      }
    };

    // SOL Airdrop
    $('btnAirdropSol').onclick = async () => {
      const addr = $('wallet').value.trim();
      if (!addr) return alert('Enter wallet address first');
      try {
        const data = await post('/api/rewards/airdrop-sol', { walletAddress: addr, amount: 2 });
        log('ğŸ’° SOL Airdrop (devnet)', data);
      } catch (e) {
        log('âŒ Airdrop Failed', e);
      }
    };

    // Scan Reward
    $('btnScanReward').onclick = async () => {
      const addr = $('wallet').value.trim();
      if (!addr) return alert('Enter wallet address');
      try {
        const payload = {
          userId: $('scanUserId').value || 'demo-user',
          walletAddress: addr,
          itemType: $('scanItemType').value,
          classification: 'recyclable',
          confidence: parseFloat($('scanConfidence').value),
          isCorrect: $('scanCorrect').value === 'true',
          location: 'Advanced Web Tester'
        };
        const data = await post('/api/rewards/scan', payload);
        $('scanResult').textContent = data.success 
          ? `âœ… Awarded ${data.data.tokensAwarded} tokens` 
          : `âŒ ${data.error}`;
        log('â™»ï¸ Scan Reward', data);
      } catch (e) {
        $('scanResult').textContent = 'âŒ Request failed';
        log('âŒ Scan Reward Failed', e);
      }
    };

    // Streak Reward
    $('btnStreakReward').onclick = async () => {
      const addr = $('wallet').value.trim();
      if (!addr) return alert('Enter wallet address');
      try {
        const payload = {
          userId: $('streakUserId').value || 'demo-user',
          walletAddress: addr,
          currentStreak: parseInt($('streakDays').value),
          streakType: $('streakType').value,
          isNewRecord: $('streakRecord').value === 'true'
        };
        const data = await post('/api/rewards/streak', payload);
        $('streakResult').textContent = data.success 
          ? `ğŸ”¥ Awarded ${data.data.tokensAwarded} tokens` 
          : `âŒ ${data.error}`;
        log('ğŸ”¥ Streak Reward', data);
      } catch (e) {
        $('streakResult').textContent = 'âŒ Request failed';
        log('âŒ Streak Reward Failed', e);
      }
    };

    // Achievement Reward
    $('btnAchievement').onclick = async () => {
      const addr = $('wallet').value.trim();
      if (!addr) return alert('Enter wallet address');
      try {
        const payload = {
          userId: $('achUserId').value || 'demo-user',
          walletAddress: addr,
          achievementType: $('achType').value,
          milestone: parseInt($('achMilestone').value),
          isRare: $('achRare').value === 'true'
        };
        const data = await post('/api/rewards/achievement', payload);
        $('achResult').textContent = data.success 
          ? `ğŸ† Awarded ${data.data.tokensAwarded} tokens` 
          : `âŒ ${data.error}`;
        log('ğŸ† Achievement Reward', data);
      } catch (e) {
        $('achResult').textContent = 'âŒ Request failed';
        log('âŒ Achievement Failed', e);
      }
    };

    // Community Reward
    $('btnCommunity').onclick = async () => {
      const addr = $('wallet').value.trim();
      if (!addr) return alert('Enter wallet address');
      try {
        const payload = {
          userId: $('commUserId').value || 'demo-user',
          walletAddress: addr,
          activityType: $('commActivity').value,
          impact: $('commImpact').value,
          userLevel: $('commLevel').value
        };
        const data = await post('/api/rewards/community', payload);
        $('commResult').textContent = data.success 
          ? `ğŸ¤ Awarded ${data.data.tokensAwarded} tokens` 
          : `âŒ ${data.error}`;
        log('ğŸ¤ Community Reward', data);
      } catch (e) {
        $('commResult').textContent = 'âŒ Request failed';
        log('âŒ Community Failed', e);
      }
    };

    // Utilities
    $('btnCheckBalance').onclick = async () => {
      const addr = $('wallet').value.trim();
      if (!addr) return alert('Enter wallet address');
      try {
        const data = await get('/api/rewards/balance/' + addr);
        log('ğŸ’° Token Balance', data);
        $('utilsResult').textContent = data.success 
          ? `Balance: ${data.data.balance} ${data.data.tokenSymbol}` 
          : 'Balance check failed';
      } catch (e) {
        log('âŒ Balance Check Failed', e);
      }
    };

    $('btnProcessQueue').onclick = async () => {
      try {
        const data = await post('/api/rewards/process-queue', {});
        log('âš¡ Process Queue', data);
      } catch (e) {
        log('âŒ Process Queue Failed', e);
      }
    };

    $('btnQueueStatus').onclick = async () => {
      try {
        const data = await get('/api/rewards/stats');
        log('ğŸ“Š Queue Status', data.data.queueStatus);
      } catch (e) {
        log('âŒ Queue Status Failed', e);
      }
    };

    $('btnSystemStats').onclick = async () => {
      try {
        const data = await get('/api/rewards/stats');
        log('ğŸ“ˆ System Statistics', data);
      } catch (e) {
        log('âŒ System Stats Failed', e);
      }
    };

    $('btnTrackTx').onclick = async () => {
      const tx = $('txHash').value.trim();
      if (!tx) return alert('Enter transaction signature');
      try {
        const data = await get('/api/rewards/transaction/' + tx);
        log('ğŸ” Transaction Status', data);
      } catch (e) {
        log('âŒ Transaction Tracking Failed', e);
      }
    };

    $('btnClearLogs').onclick = () => {
      $('log').textContent = '';
      logCount = 0;
      log('ğŸ—‘ï¸ Logs cleared');
    };

    $('btnExportLogs').onclick = () => {
      const logs = $('log').textContent;
      const blob = new Blob([logs], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `waste-wise-logs-${new Date().toISOString().slice(0,19)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Initialize
    setTimeout(() => $('btnCheckApi').click(), 500);
    log('ğŸš€ Advanced Token Tester initialized');
  </script>
</body>
</html>
